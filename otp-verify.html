<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify OTP - Goods Vehicle Booking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .lock-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    
    .booking-info {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #667eea;
    }
    
    .booking-info p {
      margin: 5px 0;
      font-size: 13px;
      color: #666;
    }
    
    .booking-info strong {
      color: #333;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .otp-input-group {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .otp-input {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .otp-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .otp-input.error {
      border-color: #f44336;
      background: #ffebee;
    }
    
    .timer {
      text-align: center;
      font-size: 13px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .timer strong {
      color: #667eea;
      font-weight: 600;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 15px;
      display: none;
      border-left: 4px solid #f44336;
    }
    
    .error-message.show {
      display: block;
    }
    
    .attempts {
      text-align: center;
      font-size: 12px;
      color: #999;
      margin-bottom: 20px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-verify {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-verify:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-verify:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-resend {
      background: #f5f5f5;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-resend:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }
    
    .btn-resend:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #ccc;
      color: #999;
    }
    
    .info-text {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 15px;
    }
    
    .info-text a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }
    
    .info-text a:hover {
      text-decoration: underline;
    }
    
    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      display: none;
      border-left: 4px solid #4caf50;
    }
    
    .success-message.show {
      display: block;
    }
    
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="lock-icon">üîê</div>
      <h1>Verify Your OTP</h1>
      <p class="subtitle">Enter the 6-digit code sent to your email</p>
    </div>
    
    <div class="booking-info">
      <p><strong>Booking ID:</strong> <span id="bookingId">--</span></p>
      <p><strong>Route:</strong> <span id="route">--</span></p>
      <p><strong>Driver will arrive soon</strong></p>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage">‚úì OTP Verified Successfully!</div>
    
    <div class="timer">
      ‚è±Ô∏è OTP expires in <strong id="timeRemaining">5:00</strong>
    </div>
    
    <form id="otpForm">
      <label>Enter OTP Code</label>
      <div class="otp-input-group">
        <input class="otp-input" id="otp1" type="text" inputmode="numeric" maxlength="1" placeholder="0" required>
        <input class="otp-input" id="otp2" type="text" inputmode="numeric" maxlength="1" placeholder="0" required>
        <input class="otp-input" id="otp3" type="text" inputmode="numeric" maxlength="1" placeholder="0" required>
        <input class="otp-input" id="otp4" type="text" inputmode="numeric" maxlength="1" placeholder="0" required>
        <input class="otp-input" id="otp5" type="text" inputmode="numeric" maxlength="1" placeholder="0" required>
        <input class="otp-input" id="otp6" type="text" inputmode="numeric" maxlength="1" placeholder="0" required>
      </div>
      
      <div class="attempts" id="attempts"></div>
      
      <div class="button-group">
        <button type="submit" class="btn-verify" id="verifyBtn">Verify OTP</button>
        <button type="button" class="btn-resend" id="resendBtn">Resend Code</button>
      </div>
    </form>
    
    <div class="info-text">
      ‚ÑπÔ∏è Your driver will ask for this code before starting the ride.<br>
      Never share this code with anyone.
    </div>
  </div>
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="js/firebase-init.js"></script>
  <script>
    const db = window.db || (window.firebase && window.firebase.firestore ? window.firebase.firestore() : null);
    const functions = (window.firebase && window.firebase.functions ? window.firebase.functions() : null);
    
    // State
    let bookingId = null;
    let booking = null;
    let otpTimer = null;
    let timeRemaining = 300; // 5 minutes
    let attempts = 0;
    
    console.log("‚úì OTP verification page loaded");
    
    // Get bookingId from URL
    document.addEventListener("DOMContentLoaded", function() {
      const params = new URLSearchParams(window.location.search);
      bookingId = params.get("bookingId");
      
      if (!bookingId) {
        showError("‚ùå Booking ID not found. Please use the link from My Orders.");
        return;
      }
      
      console.log(`‚Üí Loading booking: ${bookingId}`);
      loadBooking();
      startTimer();
      setupOTPInput();
      setupForm();
    });
    
    // Load booking details
    async function loadBooking() {
      try {
        const doc = await db.collection("bookings").doc(bookingId).get();
        if (!doc.exists) {
          showError("‚ùå Booking not found");
          return;
        }
        
        booking = doc.data();
        console.log("‚úì Booking loaded:", booking);
        
        // Display booking info
        document.getElementById("bookingId").textContent = bookingId;
        document.getElementById("route").textContent = `${booking.pickup} ‚Üí ${booking.drop}`;
        
        // Check if already verified
        if (booking.otpVerified) {
          showSuccess("‚úì This booking is already verified!");
          setTimeout(() => {
            window.location.href = "my-orders.html";
          }, 2000);
          return;
        }
        
        // Load attempts count
        attempts = booking.otpAttempts || 0;
        updateAttemptsDisplay();
        
      } catch (err) {
        console.error("‚úó Error loading booking:", err);
        showError("‚ùå Failed to load booking details");
      }
    }
    
    // Setup OTP input navigation
    function setupOTPInput() {
      const inputs = document.querySelectorAll(".otp-input");
      
      inputs.forEach((input, index) => {
        // Auto-focus next input when filled
        input.addEventListener("input", function() {
          if (this.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        });
        
        // Allow backspace to move to previous
        input.addEventListener("keydown", function(e) {
          if (e.key === "Backspace" && !this.value && index > 0) {
            inputs[index - 1].focus();
          }
        });
        
        // Only allow numbers
        input.addEventListener("keypress", function(e) {
          if (!/[0-9]/.test(e.key)) {
            e.preventDefault();
          }
        });
      });
    }
    
    // Setup form submission
    function setupForm() {
      document.getElementById("otpForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await verifyOTP();
      });
      
      document.getElementById("resendBtn").addEventListener("click", async (e) => {
        e.preventDefault();
        await sendOTP();
      });
    }
    
    // Verify OTP
    async function verifyOTP() {
      // Collect OTP from inputs
      const inputs = document.querySelectorAll(".otp-input");
      const otp = Array.from(inputs).map(input => input.value).join("");
      
      if (otp.length !== 6) {
        showError("‚ùå Please enter all 6 digits");
        return;
      }
      
      const verifyBtn = document.getElementById("verifyBtn");
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<span class="spinner"></span>Verifying...';
      
      try {
        console.log("‚Üí Verifying OTP");
        
        const result = await functions.httpsCallable("verifyOTP")({
          bookingId: bookingId,
          otp: otp
        });
        
        console.log("‚úì OTP verified:", result.data);
        showSuccess("‚úì OTP Verified Successfully!");
        
        // Clear inputs
        inputs.forEach(input => input.value = "");
        
        // Disable timer
        if (otpTimer) clearInterval(otpTimer);
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = "my-orders.html";
        }, 2000);
        
      } catch (error) {
        console.error("‚úó Verification error:", error);
        
        // Remove error class from inputs
        inputs.forEach(input => input.classList.remove("error"));
        
        // Show specific error
        let errorMsg = error.message || "Failed to verify OTP";
        if (error.code === "failed-precondition") {
          // OTP expired or other precondition error
          errorMsg = error.message;
          if (errorMsg.includes("expired")) {
            showError("‚ùå OTP has expired. Please request a new code.");
          } else {
            showError(`‚ùå ${errorMsg}`);
          }
        } else if (error.code === "invalid-argument") {
          // Wrong OTP
          errorMsg = error.message;
          inputs.forEach(input => input.classList.add("error"));
          showError(`‚ùå ${errorMsg}`);
        } else {
          showError(`‚ùå ${errorMsg}`);
        }
        
        // Update attempts if loaded from error message
        if (booking) {
          attempts = booking.otpAttempts || 0;
          updateAttemptsDisplay();
        }
        
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = "Verify OTP";
      }
    }
    
    // Request/Resend OTP
    async function sendOTP() {
      const resendBtn = document.getElementById("resendBtn");
      resendBtn.disabled = true;
      resendBtn.textContent = "Sending...";
      
      try {
        console.log("‚Üí Requesting OTP");
        
        const result = await functions.httpsCallable("sendOTP")({
          bookingId: bookingId,
          customerEmail: booking.customerEmail || booking.email,
          customerName: booking.name
        });
        
        console.log("‚úì OTP sent:", result.data);
        showError("‚úÖ New OTP sent to your email!");
        
        // Reset timer
        timeRemaining = 300;
        if (otpTimer) clearInterval(otpTimer);
        startTimer();
        
        // Clear inputs
        document.querySelectorAll(".otp-input").forEach(input => {
          input.value = "";
          input.classList.remove("error");
        });
        
        // Reset attempts display
        attempts = 0;
        updateAttemptsDisplay();
        
      } catch (error) {
        console.error("‚úó Resend error:", error);
        showError(`‚ùå Failed to resend OTP: ${error.message}`);
      } finally {
        resendBtn.disabled = false;
        resendBtn.textContent = "Resend Code";
      }
    }
    
    // Timer for OTP expiry
    function startTimer() {
      otpTimer = setInterval(() => {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, "0")}`;
        
        document.getElementById("timeRemaining").textContent = timeStr;
        
        if (timeRemaining <= 0) {
          clearInterval(otpTimer);
          showError("‚ùå OTP has expired. Please request a new code.");
          document.getElementById("verifyBtn").disabled = true;
          document.getElementById("otpForm").style.opacity = "0.5";
        }
      }, 1000);
    }
    
    // Update attempts display
    function updateAttemptsDisplay() {
      const attemptsEl = document.getElementById("attempts");
      if (attempts > 0 && attempts < 3) {
        attemptsEl.textContent = `‚ö†Ô∏è ${3 - attempts} attempt${3 - attempts === 1 ? "" : "s"} remaining`;
        attemptsEl.style.color = "#d32f2f";
      } else if (attempts >= 3) {
        attemptsEl.textContent = "‚ùå Too many attempts. Request a new OTP.";
        attemptsEl.style.color = "#c62828";
        document.getElementById("verifyBtn").disabled = true;
      }
    }
    
    // Show error message
    function showError(message) {
      const errorEl = document.getElementById("errorMessage");
      errorEl.textContent = message;
      errorEl.classList.add("show");
      errorEl.style.background = message.includes("‚úÖ") ? "#e8f5e9" : "#ffebee";
      errorEl.style.color = message.includes("‚úÖ") ? "#2e7d32" : "#c62828";
      errorEl.style.borderColor = message.includes("‚úÖ") ? "#4caf50" : "#f44336";
      
      setTimeout(() => {
        if (!message.includes("‚úÖ")) {
          errorEl.classList.remove("show");
        }
      }, 5000);
    }
    
    // Show success message
    function showSuccess(message) {
      const successEl = document.getElementById("successMessage");
      successEl.textContent = message;
      successEl.classList.add("show");
    }
  </script>
</body>
</html>
