<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
    }
    .driver-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .driver-header h1 {
      margin: 0;
      font-size: 24px;
    }
    .driver-status {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .status-badge {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-badge.online {
      background: #4caf50;
    }
    .status-badge.offline {
      background: #f44336;
    }
    .btn-toggle-status {
      padding: 8px 16px;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-toggle-status:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .btn-logout {
      padding: 8px 16px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-logout:hover {
      background: #d32f2f;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #999;
      font-size: 12px;
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    .bookings-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 20px;
    }
    .bookings-section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .booking-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s;
      border-left: 4px solid #667eea;
    }
    .booking-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .route-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
    }
    .route-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .route-modal-content {
      background-color: white;
      padding: 0;
      border-radius: 12px;
      width: 95%;
      height: 90vh;
      max-width: 1200px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }
    .route-modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .route-modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .close-route-modal {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-route-modal:hover {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
    }
    .route-modal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }
    .route-map-container {
      flex: 2;
      position: relative;
      background: #e5e3df;
      border-radius: 0 0 0 12px;
    }
    #bookingRouteMap {
      width: 100%;
      height: 100%;
      border-radius: 0 0 0 12px;
    }
    .route-info-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: white;
      border-radius: 0 0 12px 0;
      border-left: 1px solid #e5e7eb;
    }
    .route-info-panel h3 {
      color: #667eea;
      margin-top: 0;
      font-size: 18px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .route-detail-item {
      margin-bottom: 15px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    .route-detail-label {
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .route-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
    }
    .route-distance-time {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .distance-box {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .distance-value {
      font-size: 28px;
      font-weight: 700;
    }
    .distance-label {
      font-size: 12px;
      opacity: 0.9;
    }
    .time-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .time-value {
      font-size: 28px;
      font-weight: 700;
    }
    .time-label {
      font-size: 12px;
      opacity: 0.9;
    }
    .booking-card h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .booking-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 13px;
      margin-bottom: 10px;
      color: #666;
    }
    .booking-info strong {
      display: block;
      color: #333;
    }
    .booking-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-accept {
      flex: 1;
      padding: 10px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-accept:hover {
      background: #45a049;
    }
    .btn-reject {
      flex: 1;
      padding: 10px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-reject:hover {
      background: #da190b;
    }
    .btn-view {
      flex: 1;
      padding: 10px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    .empty-state p {
      font-size: 18px;
      margin: 0;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="driver-header">
    <div>
      <h1>üöó Driver Dashboard</h1>
      <p style="margin:5px 0 0 0; opacity:0.9;" id="driverName">Loading...</p>
    </div>
    <div class="driver-status">
      <span class="status-badge offline" id="statusBadge">Offline</span>
      <button class="btn-toggle-status" id="toggleStatusBtn">Go Online</button>
      <button class="btn-logout" id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- ROUTE MAP MODAL - Shows individual booking routes -->
  <div id="routeModal" class="route-modal">
    <div class="route-modal-content">
      <div class="route-modal-header">
        <h2>üìç Booking Route Details</h2>
        <button class="close-route-modal" onclick="closeRouteModal()">&times;</button>
      </div>
      <div class="route-modal-body">
        <div class="route-map-container">
          <div id="bookingRouteMap"></div>
        </div>
        <div class="route-info-panel">
          <h3>Trip Information</h3>
          <div class="route-distance-time">
            <div class="distance-box">
              <div class="distance-value" id="routeDistanceVal">0</div>
              <div class="distance-label">km</div>
            </div>
            <div class="time-box">
              <div class="time-value" id="routeTimeVal">0</div>
              <div class="time-label">min</div>
            </div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">üìç Pickup Location</div>
            <div class="route-detail-value" id="pickupDetailVal">-</div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">üéØ Drop Location</div>
            <div class="route-detail-value" id="dropDetailVal">-</div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">üë§ Customer Name</div>
            <div class="route-detail-value" id="customerNameVal">-</div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">üìû Customer Phone</div>
            <div class="route-detail-value" id="customerPhoneVal">-</div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">üöõ Vehicle Type</div>
            <div class="route-detail-value" id="vehicleTypeVal">-</div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">üí∞ Estimated Price</div>
            <div class="route-detail-value" id="priceVal" style="color: #ff6b35; font-size: 18px;">-</div>
          </div>
          <div class="route-detail-item">
            <div class="route-detail-label">‚è±Ô∏è Status</div>
            <div class="route-detail-value" id="statusVal">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="stats-container">
      <div class="stat-card">
        <h3>Available</h3>
        <div class="value" id="pendingCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Accepted</h3>
        <div class="value" id="acceptedCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Completed</h3>
        <div class="value" id="completedCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Rating</h3>
        <div class="value" id="ratingValue">5.0</div>
      </div>
    </div>

    <div class="bookings-section">
      <h2>üì¶ Available Bookings</h2>
      <div id="bookingsList">
        <div class="empty-state">
          <p>No bookings available</p>
        </div>
      </div>
    </div>

    <div class="bookings-section" style="margin-top:30px;">
      <h2>‚úì Your Active Rides</h2>
      <div id="activeRidesList">
        <div class="empty-state">
          <p>No active rides</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">‚úï</button>
      <h2>Booking Details</h2>
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAI4QSMoukoQR8xivZr-0eUUc8kKARkOd4",
      authDomain: "goods-5097f.firebaseapp.com",
      projectId: "goods-5097f",
      storageBucket: "goods-5097f.firebasestorage.app",
      messagingSenderId: "693060796720",
      appId: "1:693060796720:web:091388170ce0c7980348f5",
      measurementId: "G-JT7D3G5TG7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentDriver = null;
    let driverStatus = "offline";
    let availableBookings = [];
    let activeRides = [];

    document.addEventListener("DOMContentLoaded", function() {
      // Auth check
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = "../driver.html";
          return;
        }

        loadDriverProfile(user.uid);
        setupRealtimeListeners();
      });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await auth.signOut();
        window.location.href = "../driver.html";
      });

      // Toggle status
      document.getElementById("toggleStatusBtn").addEventListener("click", async () => {
        if (!currentDriver) return;
        driverStatus = driverStatus === "online" ? "offline" : "online";
        await db.collection("drivers").doc(currentDriver.uid).update({
          status: driverStatus,
          lastStatusChange: new Date().toISOString()
        });
      });

      console.log("‚úì Driver dashboard loaded");
    });

    async function loadDriverProfile(uid) {
      try {
        let doc = await db.collection("drivers").doc(uid).get();
        if (!doc.exists) {
          // Create profile if missing
          await db.collection("drivers").doc(uid).set({
            uid,
            status: "offline",
            rating: 5.0,
            totalRides: 0,
            createdAt: new Date().toISOString()
          });
          doc = await db.collection("drivers").doc(uid).get();
          console.log("‚úì Driver profile created");
        }
        currentDriver = { uid, ...doc.data() };
        document.getElementById("driverName").innerText = currentDriver.name || "Driver " + uid.substring(0, 5);
        document.getElementById("ratingValue").innerText = (currentDriver.rating || 5.0).toFixed(1);
        driverStatus = currentDriver.status || "offline";
        updateStatusUI();
        console.log("‚úì Driver profile loaded:", currentDriver.name || "Unknown");
      } catch (err) {
        console.error("‚úó Error loading driver:", err);
        document.getElementById("driverName").innerText = "Error loading profile";
      }
    }

    function setupRealtimeListeners() {
      // Listen to pending bookings
      db.collection("bookings")
        .where("status", "==", "new")
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot(snapshot => {
          availableBookings = [];
          snapshot.forEach(doc => {
            availableBookings.push({ id: doc.id, ...doc.data() });
          });
          updateAvailableBookings();
          document.getElementById("pendingCount").innerText = availableBookings.length;
          console.log(`‚úì Available bookings: ${availableBookings.length}`);
        });

      // Listen to driver's accepted rides
      if (currentDriver) {
        db.collection("bookings")
          .where("driverPhone", "==", currentDriver.phone)
          .where("status", "in", ["confirmed", "in_transit"])
          .orderBy("createdAt", "desc")
          .onSnapshot(snapshot => {
            activeRides = [];
            snapshot.forEach(doc => {
              activeRides.push({ id: doc.id, ...doc.data() });
            });
            updateActiveRides();
            document.getElementById("acceptedCount").innerText = activeRides.length;
            console.log(`‚úì Active rides: ${activeRides.length}`);
          });
      }
    }

    function updateAvailableBookings() {
      const list = document.getElementById("bookingsList");
      if (availableBookings.length === 0) {
        list.innerHTML = '<div class="empty-state"><p>No bookings available</p></div>';
        return;
      }

      list.innerHTML = availableBookings.map(b => `
        <div class="booking-card">
          <h3>üìç ${b.pickup} ‚Üí ${b.drop}</h3>
          <div class="booking-info">
            <div><strong>Customer:</strong> ${b.name}</div>
            <div><strong>Phone:</strong> ${b.phone}</div>
            <div><strong>Distance:</strong> ${(b.distance || 0).toFixed(1)} km</div>
            <div><strong>Price:</strong> ‚Çπ${b.estimatedPrice}</div>
            <div><strong>Vehicle:</strong> ${b.vehicle}</div>
            <div><strong>Loading:</strong> ${b.loadingRequired ? 'Yes' : 'No'}</div>
          </div>
          ${b.notes ? `<div style="background:#fff3cd; padding:8px; border-radius:4px; font-size:12px; color:#333; margin-bottom:10px;"><strong>Notes:</strong> ${b.notes}</div>` : ''}
          <div class="booking-actions">
            <button class="btn-accept" onclick="acceptBooking('${b.id}')">‚úì Accept</button>
            <button class="btn-reject" onclick="rejectBooking('${b.id}')">‚úó Reject</button>
            <button class="btn-view" onclick="viewDetails('${b.id}', 'available')">View</button>
          </div>
        </div>
      `).join("");
    }

    function updateActiveRides() {
      const list = document.getElementById("activeRidesList");
      if (activeRides.length === 0) {
        list.innerHTML = '<div class="empty-state"><p>No active rides</p></div>';
        return;
      }

      list.innerHTML = activeRides.map(r => `
        <div class="booking-card" style="border-color:#667eea;">
          <h3>‚úì ${r.pickup} ‚Üí ${r.drop}</h3>
          <div class="booking-info">
            <div><strong>Status:</strong> <span style="background:#667eea; color:white; padding:2px 8px; border-radius:3px;">${r.status}</span></div>
            <div><strong>Customer:</strong> ${r.name}</div>
            <div><strong>Distance:</strong> ${(r.distance || 0).toFixed(1)} km</div>
            <div><strong>Price:</strong> ‚Çπ${r.estimatedPrice}</div>
          </div>
          <div class="booking-actions">
            ${r.status === 'confirmed' ? `<button class="btn-accept" onclick="startRide('${r.id}')">‚ñ∂ Start Ride</button>` : ''}
            ${r.status === 'in_transit' ? `<button class="btn-accept" onclick="completeRide('${r.id}')">‚úì Complete</button>` : ''}
            <button class="btn-view" onclick="viewDetails('${r.id}', 'active')">View</button>
          </div>
        </div>
      `).join("");
    }

    async function acceptBooking(bookingId) {
      if (!currentDriver) {
        alert("Driver profile not loaded");
        return;
      }

      // Validate phone field
      if (!currentDriver.phone || currentDriver.phone.trim() === "") {
        alert("Please update your phone number in driver profile");
        return;
      }

      try {
        await db.collection("bookings").doc(bookingId).update({
          status: "confirmed",
          driverPhone: currentDriver.phone,
          driverName: currentDriver.name || "Driver",
          acceptedAt: new Date().toISOString()
        });

        // Create notification for customer
        const booking = availableBookings.find(b => b.id === bookingId);
        if (booking) {
          await db.collection("notifications").add({
            bookingId,
            phone: booking.phone,
            name: booking.name,
            type: "driver_accepted",
            driverName: currentDriver.name,
            driverPhone: currentDriver.phone,
            createdAt: new Date().toISOString(),
            sent: false
          });
        }

        alert("‚úì Booking accepted!");
        console.log("‚úì Booking accepted:", bookingId);
      } catch (err) {
        console.error("‚úó Error accepting booking:", err);
        alert("Error accepting booking: " + err.message);
      }
    }

    async function rejectBooking(bookingId) {
      try {
        await db.collection("bookings").doc(bookingId).update({
          rejectedByDrivers: firebase.firestore.FieldValue.arrayUnion(currentDriver.phone),
          updatedAt: new Date().toISOString()
        });
        alert("‚úì Booking rejected");
        console.log("‚úì Booking rejected:", bookingId);
      } catch (err) {
        console.error("‚úó Error rejecting booking:", err);
        alert("Error rejecting booking: " + err.message);
      }
    }

    async function startRide(bookingId) {
      try {
        await db.collection("bookings").doc(bookingId).update({
          status: "in_transit",
          startedAt: new Date().toISOString()
        });
        alert("‚úì Ride started!");
        console.log("‚úì Ride started:", bookingId);
      } catch (err) {
        console.error("‚úó Error starting ride:", err);
        alert("Error: " + err.message);
      }
    }

    async function completeRide(bookingId) {
      try {
        await db.collection("bookings").doc(bookingId).update({
          status: "completed",
          completedAt: new Date().toISOString()
        });

        // Update driver stats
        const completedCount = activeRides.length;
        await db.collection("drivers").doc(currentDriver.uid).update({
          totalRides: firebase.firestore.FieldValue.increment(1)
        });

        alert("‚úì Ride completed!");
        console.log("‚úì Ride completed:", bookingId);
      } catch (err) {
        console.error("‚úó Error completing ride:", err);
        alert("Error: " + err.message);
      }
    }

    function viewDetails(bookingId, type) {
      const list = type === 'available' ? availableBookings : activeRides;
      const booking = list.find(b => b.id === bookingId);
      if (!booking) return;

      // Show route map modal instead of text modal
      showRouteMap(booking);
    }

    // NEW FUNCTION: Show route map for a specific booking
    async function showRouteMap(booking) {
      // Populate route info panel
      document.getElementById("pickupDetailVal").innerText = booking.pickup || "-";
      document.getElementById("dropDetailVal").innerText = booking.drop || "-";
      document.getElementById("customerNameVal").innerText = booking.name || "-";
      document.getElementById("customerPhoneVal").innerText = booking.phone || "-";
      document.getElementById("vehicleTypeVal").innerText = booking.vehicle || "-";
      document.getElementById("priceVal").innerText = `‚Çπ${booking.estimatedPrice || "0"}`;
      document.getElementById("statusVal").innerText = booking.status || "-";
      document.getElementById("routeDistanceVal").innerText = (booking.distance || 0).toFixed(1);
      document.getElementById("routeTimeVal").innerText = Math.round(booking.distance * 2) || "0";

      // Initialize or reset map
      if (window.routeMapInstance) {
        window.routeMapInstance.remove();
      }

      // Create fresh map for this booking
      window.routeMapInstance = L.map("bookingRouteMap").setView([20.5937, 78.9629], 5);
      
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap",
        maxZoom: 19,
        minZoom: 4
      }).addTo(window.routeMapInstance);

      // Restrict to India
      const indiaBounds = L.latLngBounds([8.4, 68.7], [35.5, 97.4]);
      window.routeMapInstance.setMaxBounds(indiaBounds);

      // Add pickup marker
      if (booking.pickupLat && booking.pickupLon) {
        L.marker([booking.pickupLat, booking.pickupLon], {
          icon: L.icon({
            iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%234CAF50"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50]
          })
        }).addTo(window.routeMapInstance).bindPopup(`<strong>üìç Pickup</strong><br>${booking.pickup}`);
      }

      // Add drop marker
      if (booking.dropLat && booking.dropLon) {
        L.marker([booking.dropLat, booking.dropLon], {
          icon: L.icon({
            iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%23EF4444"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50]
          })
        }).addTo(window.routeMapInstance).bindPopup(`<strong>üéØ Destination</strong><br>${booking.drop}`);
      }

      // Draw route
      if (booking.pickupLat && booking.pickupLon && booking.dropLat && booking.dropLon) {
        try {
          const routePoints = await getRoutePolyline(
            booking.pickupLat, booking.pickupLon,
            booking.dropLat, booking.dropLon
          );

          if (routePoints && routePoints.length > 0) {
            // Shadow layer
            L.polyline(routePoints, {
              color: "#ffffff",
              weight: 8,
              opacity: 0.4,
              lineCap: "round",
              lineJoin: "round"
            }).addTo(window.routeMapInstance);

            // Main route
            L.polyline(routePoints, {
              color: "#4f46e5",
              weight: 5,
              opacity: 0.9,
              lineCap: "round",
              lineJoin: "round"
            }).addTo(window.routeMapInstance);

            // Fit bounds
            const bounds = L.latLngBounds(routePoints);
            window.routeMapInstance.fitBounds(bounds, { padding: [50, 50] });
          } else {
            // Fallback straight line
            L.polyline([
              [booking.pickupLat, booking.pickupLon],
              [booking.dropLat, booking.dropLon]
            ], {
              color: "#4f46e5",
              weight: 5,
              opacity: 0.6,
              dashArray: "5, 5"
            }).addTo(window.routeMapInstance);
          }
        } catch (err) {
          console.error("Route error:", err);
        }
      }

      // Show the modal
      document.getElementById("routeModal").classList.add("active");
    }

    // Get route polyline from OSRM
    async function getRoutePolyline(lat1, lon1, lat2, lon2) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const coordinates = data.routes[0].geometry.coordinates;
          return coordinates.map(coord => [coord[1], coord[0]]); // Convert [lon,lat] to [lat,lon]
        }
      } catch (err) {
        console.error("Route fetch error:", err);
      }
      return null;
    }

    function closeRouteModal() {
      document.getElementById("routeModal").classList.remove("active");
      if (window.routeMapInstance) {
        window.routeMapInstance.remove();
        window.routeMapInstance = null;
      }
    }

    function closeModal() {
      document.getElementById("detailModal").classList.remove("active");
    }

    function updateStatusUI() {
      const badge = document.getElementById("statusBadge");
      const btn = document.getElementById("toggleStatusBtn");

      if (driverStatus === "online") {
        badge.classList.remove("offline");
        badge.classList.add("online");
        badge.innerText = "Online";
        btn.innerText = "Go Offline";
      } else {
        badge.classList.remove("online");
        badge.classList.add("offline");
        badge.innerText = "Offline";
        btn.innerText = "Go Online";
      }
    }
  </script>
</body>
</html>
