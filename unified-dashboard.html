<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unified Dashboard - Goods Vehicle Booking</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    .workflow-container {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      margin: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .workflow-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .step {
      text-align: center;
      padding: 25px;
      background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%);
      border-radius: 12px;
      border: 2px solid #ff6b35;
      position: relative;
    }

    .step-number {
      font-size: 32px;
      font-weight: 700;
      color: #ff6b35;
      margin-bottom: 10px;
    }

    .step-title {
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 10px;
    }

    .step-desc {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.5;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      padding: 20px;
      border-radius: 12px;
      color: white;
      text-align: center;
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.2);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
    }

    .dashboard-section {
      background: white;
      padding: 35px;
      border-radius: 16px;
      margin: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .dashboard-section h3 {
      color: #ff6b35;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 24px;
      border-bottom: 3px solid #ff6b35;
      padding-bottom: 15px;
    }

    .booking-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 5px solid #ff6b35;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: start;
    }

    .booking-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      font-size: 14px;
    }

    .booking-info-item {
      display: flex;
      flex-direction: column;
    }

    .booking-info-label {
      font-weight: 700;
      color: #ff6b35;
      margin-bottom: 3px;
    }

    .booking-info-value {
      color: #374151;
    }

    .booking-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
    }

    .btn-accept {
      background: #10b981;
      color: white;
    }

    .btn-accept:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .btn-reject {
      background: #ef4444;
      color: white;
    }

    .btn-reject:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    .btn-start {
      background: #3b82f6;
      color: white;
    }

    .btn-start:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .btn-complete {
      background: #8b5cf6;
      color: white;
    }

    .btn-complete:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }

    #map {
      height: 400px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    }

    .export-btn {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .export-btn:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      color: white;
      text-align: center;
    }

    .status-new {
      background: #f97316;
    }

    .status-confirmed {
      background: #3b82f6;
    }

    .status-in-transit {
      background: #a855f7;
    }

    .status-completed {
      background: #10b981;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
      font-style: italic;
    }

    .user-section {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info h2 {
      margin: 0;
      font-size: 24px;
    }

    .user-info p {
      margin: 5px 0 0 0;
      opacity: 0.9;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: white;
      color: #ff6b35;
    }

    @media (max-width: 768px) {
      .workflow-steps {
        grid-template-columns: 1fr;
      }

      .booking-card {
        grid-template-columns: 1fr;
      }

      .user-section {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="workflow-container">
    <h2 style="color:#ff6b35; text-align:center; margin-top:0;">üìã How It Works</h2>
    <div class="workflow-steps">
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-title">Customer Books</div>
        <div class="step-desc">Customer fills booking form with pickup, drop location & vehicle type</div>
      </div>
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-title">Payment</div>
        <div class="step-desc">Distance calculated, price quoted, customer confirms</div>
      </div>
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-title">Driver Sees</div>
        <div class="step-desc">New booking appears in driver's available bookings</div>
      </div>
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-title">Driver Accepts</div>
        <div class="step-desc">Driver reviews & accepts the booking</div>
      </div>
      <div class="step">
        <div class="step-number">5</div>
        <div class="step-title">In Transit</div>
        <div class="step-desc">Driver starts ride, customer gets driver details</div>
      </div>
      <div class="step">
        <div class="step-number">6</div>
        <div class="step-title">Complete</div>
        <div class="step-desc">Ride completed, booking closed, both rated</div>
      </div>
    </div>
  </div>

  <!-- Stats Section -->
  <div class="dashboard-section">
    <h3>üìä Dashboard Stats</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalBookings">0</div>
        <div class="stat-label">Total Bookings</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="newBookings">0</div>
        <div class="stat-label">New Bookings</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="acceptedBookings">0</div>
        <div class="stat-label">Accepted</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="completedBookings">0</div>
        <div class="stat-label">Completed</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalRevenue">‚Çπ0</div>
        <div class="stat-label">Total Revenue</div>
      </div>
    </div>
  </div>

  <!-- Map Section -->
  <div class="dashboard-section">
    <h3>üìç Live Map View</h3>
    <div id="map"></div>
    <p style="font-size:12px; color:#9ca3af; margin:10px 0 0 0;">üîµ Blue = Pickup | üî¥ Red = Drop-off locations</p>
  </div>

  <!-- Driver Section -->
  <div class="dashboard-section">
    <div class="user-section">
      <div class="user-info">
        <h2 id="driverName">üë§ Driver Dashboard</h2>
        <p id="driverPhone" style="display:none;">Phone: <span id="driverPhoneValue">-</span></p>
      </div>
      <button class="logout-btn" id="logoutBtn" style="display:none;">üîì Logout</button>
    </div>

    <h3>üì¶ Available Bookings (New)</h3>
    <div id="availableBookingsList">
      <div class="empty-state">No available bookings yet</div>
    </div>

    <h3 style="margin-top:30px;">‚úì Your Accepted Bookings</h3>
    <div id="acceptedBookingsList">
      <div class="empty-state">No accepted bookings</div>
    </div>

    <h3 style="margin-top:30px;">üìã All Bookings (Admin Control)</h3>
    <div style="margin-bottom:20px; display:grid; grid-template-columns: 1fr auto; gap:15px; align-items:center;">
      <div>
        <input id="searchBox" type="text" placeholder="Search by name, phone, pickup, or drop..." style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:14px; transition:all 0.3s ease;">
      </div>
      <select id="statusFilter" style="width:150px; padding:12px; border-radius:8px; border:2px solid #ff6b35;">
        <option value="">All Status</option>
        <option value="new">New</option>
        <option value="confirmed">Confirmed</option>
        <option value="in_transit">In Transit</option>
        <option value="completed">Completed</option>
      </select>
      <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
    </div>
    <div id="allBookingsList">
      <div class="empty-state">No bookings</div>
    </div>
  </div>

  <!-- Modal for booking details -->
  <div id="detailModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:16px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
      <button onclick="closeModal()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer;">‚úï</button>
      <h3 id="detailTitle">Booking Details</h3>
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- Modal for turn-by-turn directions -->
  <div id="directionsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1001; display:flex; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:16px; max-width:600px; width:90%; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <button onclick="closeDirectionsModal()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer;">‚úï</button>
      <h3 style="margin-top:0; color:#667eea;">üó∫Ô∏è Turn-by-Turn Directions</h3>
      <div id="directionsContent" style="margin-top:20px;"></div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAI4QSMoukoQR8xivZr-0eUUc8kKARkOd4",
      authDomain: "goods-5097f.firebaseapp.com",
      projectId: "goods-5097f",
      storageBucket: "goods-5097f.firebasestorage.app",
      messagingSenderId: "693060796720",
      appId: "1:693060796720:web:091388170ce0c7980348f5",
      measurementId: "G-JT7D3G5TG7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentDriver = null;
    let allBookings = [];

    // Vehicle icon mapping
    const vehicleIcons = {
      "Mini Truck": { emoji: "üöõ", capacity: "Up to 2 tons", basePrice: "‚Çπ250" },
      "Pickup": { emoji: "üöô", capacity: "Up to 1 ton", basePrice: "‚Çπ200" },
      "Tempo": { emoji: "üöê", capacity: "Up to 3 tons", basePrice: "‚Çπ300" }
    };

    function getVehicleIcon(vehicleName) {
      return vehicleIcons[vehicleName]?.emoji || "üöö";
    }

    function getVehicleInfo(vehicleName) {
      return vehicleIcons[vehicleName] || { emoji: "üöö", capacity: "Standard", basePrice: "‚Çπ200" };
    }
    let availableBookings = [];
    let acceptedBookings = [];

    document.addEventListener("DOMContentLoaded", function() {
      // Check driver auth
      auth.onAuthStateChanged(user => {
        if (user) {
          loadDriverProfile(user.uid);
          document.getElementById("logoutBtn").style.display = "block";
        } else {
          document.getElementById("logoutBtn").style.display = "none";
          document.getElementById("driverName").textContent = "üë§ Driver Dashboard (Not Logged In)";
        }
      });

      // Setup real-time all bookings listener for stats
      setupStatsListener();

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await auth.signOut();
        currentDriver = null;
        window.location.reload();
      });

      // Status filter
      document.getElementById("statusFilter").addEventListener("change", updateAllBookings);

      // Search box
      document.getElementById("searchBox").addEventListener("keyup", updateAllBookings);

      // Initialize map
      initializeMap();

      console.log("‚úì Unified dashboard loaded");
    });

    async function loadDriverProfile(uid) {
      try {
        let doc = await db.collection("drivers").doc(uid).get();
        if (!doc.exists) {
          await db.collection("drivers").doc(uid).set({
            uid,
            phone: "",
            name: "",
            status: "offline",
            rating: 5.0,
            totalRides: 0,
            createdAt: new Date().toISOString()
          });
          doc = await db.collection("drivers").doc(uid).get();
          console.log("‚úì New driver profile created");
        }
        currentDriver = { uid, ...doc.data() };
        document.getElementById("driverName").textContent = "üöó " + (currentDriver.name || "Driver " + uid.substring(0, 5));
        if (currentDriver.phone) {
          document.getElementById("driverPhone").style.display = "block";
          document.getElementById("driverPhoneValue").textContent = currentDriver.phone;
        }
        console.log("‚úì Driver profile loaded:", currentDriver.name || uid.substring(0, 5));
        
        // Now setup listeners after driver is loaded
        setupDriverListeners();
      } catch (err) {
        console.error("‚úó Error loading driver:", err);
      }
    }

    function setupStatsListener() {
      db.collection("bookings").orderBy("createdAt", "desc").limit(1000).onSnapshot(snapshot => {
        allBookings = [];
        snapshot.forEach(doc => {
          allBookings.push({ id: doc.id, ...doc.data() });
        });
        updateStats();
        updateAllBookings();
        updateMap();
        console.log("‚úì All bookings updated:", allBookings.length);
      }, err => {
        console.error("‚úó Error loading all bookings:", err);
      });
    }

    function setupDriverListeners() {
      if (!currentDriver) {
        console.log("‚ö† No driver profile yet");
        return;
      }

      // Available bookings (new)
      db.collection("bookings")
        .where("status", "==", "new")
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot(snapshot => {
          availableBookings = [];
          snapshot.forEach(doc => {
            availableBookings.push({ id: doc.id, ...doc.data() });
          });
          updateAvailableBookings();
          console.log("‚úì Available bookings updated:", availableBookings.length);
        }, err => {
          console.error("‚úó Error loading available bookings:", err);
        });

      // Accepted bookings - only if driver has phone
      if (currentDriver.phone && currentDriver.phone.trim() !== "") {
        db.collection("bookings")
          .where("driverPhone", "==", currentDriver.phone)
          .where("status", "in", ["confirmed", "in_transit"])
          .orderBy("createdAt", "desc")
          .limit(50)
          .onSnapshot(snapshot => {
            acceptedBookings = [];
            snapshot.forEach(doc => {
              acceptedBookings.push({ id: doc.id, ...doc.data() });
            });
            updateAcceptedBookings();
            console.log("‚úì Accepted bookings updated:", acceptedBookings.length);
          }, err => {
            console.error("‚úó Error loading accepted bookings:", err);
          });
      } else {
        console.warn("‚ö† Driver has no phone number set");
      }
    }

    function updateStats() {
      const total = allBookings.length;
      const newCount = allBookings.filter(b => b.status === "new").length;
      const confirmedCount = allBookings.filter(b => b.status === "confirmed").length;
      const completedCount = allBookings.filter(b => b.status === "completed").length;
      const revenue = allBookings.filter(b => b.status === "completed").reduce((sum, b) => sum + (b.estimatedPrice || 0), 0);

      document.getElementById("totalBookings").textContent = total;
      document.getElementById("newBookings").textContent = newCount;
      document.getElementById("acceptedBookings").textContent = confirmedCount;
      document.getElementById("completedBookings").textContent = completedCount;
      document.getElementById("totalRevenue").textContent = "‚Çπ" + revenue.toLocaleString("en-IN");
    }

    function updateAvailableBookings() {
      const container = document.getElementById("availableBookingsList");
      if (availableBookings.length === 0) {
        container.innerHTML = '<div class="empty-state">No available bookings yet</div>';
        return;
      }

      container.innerHTML = availableBookings.map(b => {
        const vehicleInfo = getVehicleInfo(b.vehicle);
        return `
        <div class="booking-card">
          <div class="booking-info">
            <div class="booking-info-item">
              <div class="booking-info-label">Customer</div>
              <div class="booking-info-value">${b.name}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Phone</div>
              <div class="booking-info-value">${b.phone}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">From</div>
              <div class="booking-info-value">${b.pickup}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">To</div>
              <div class="booking-info-value">${b.drop}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Distance</div>
              <div class="booking-info-value">${(b.distance || 0).toFixed(2)} km</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Vehicle</div>
              <div class="booking-info-value"><span style="font-size:20px; margin-right:6px;">${vehicleInfo.emoji}</span>${b.vehicle}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Price</div>
              <div class="booking-info-value">‚Çπ${b.estimatedPrice}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Status</div>
              <span class="status-badge status-new">${b.status}</span>
            </div>
          </div>
          <div class="booking-actions">
            <button class="btn-small btn-accept" onclick="acceptBooking('${b.id}')">‚úì Accept</button>
            <button class="btn-small btn-reject" onclick="rejectBooking('${b.id}')">‚úï Reject</button>
            <button class="btn-small" style="background:#6b7280;" onclick="viewDetails('${b.id}', 'available')">‚ÑπÔ∏è Details</button>
          </div>
        </div>
      `;
      }).join("");
    }

    function updateAcceptedBookings() {
      const container = document.getElementById("acceptedBookingsList");
      if (acceptedBookings.length === 0) {
        container.innerHTML = '<div class="empty-state">No accepted bookings</div>';
        return;
      }

      container.innerHTML = acceptedBookings.map(b => {
        const vehicleInfo = getVehicleInfo(b.vehicle);
        return `
        <div class="booking-card">
          <div class="booking-info">
            <div class="booking-info-item">
              <div class="booking-info-label">Customer</div>
              <div class="booking-info-value">${b.name}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Phone</div>
              <div class="booking-info-value"><a href="https://wa.me/91${b.phone}" target="_blank" style="color:#25d366;">üì± ${b.phone}</a></div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">From</div>
              <div class="booking-info-value">${b.pickup}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">To</div>
              <div class="booking-info-value">${b.drop}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Distance</div>
              <div class="booking-info-value">${(b.distance || 0).toFixed(2)} km</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Vehicle</div>
              <div class="booking-info-value"><span style="font-size:20px; margin-right:6px;">${vehicleInfo.emoji}</span>${b.vehicle}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Status</div>
              <span class="status-badge ${b.status === 'confirmed' ? 'status-confirmed' : 'status-in-transit'}">${b.status === 'confirmed' ? 'Confirmed' : 'In Transit'}</span>
            </div>
          </div>
          <div class="booking-actions">
            ${b.status === 'confirmed' ? `<button class="btn-small btn-start" onclick="startRide('${b.id}')">‚ñ∂ Start</button>` : ''}
            <button class="btn-small btn-complete" onclick="completeRide('${b.id}')">‚úì Complete</button>
            <button class="btn-small" style="background:#6b7280;" onclick="viewDetails('${b.id}', 'accepted')">‚ÑπÔ∏è Details</button>
          </div>
        </div>
      `;
      }).join("");
    }

    async function acceptBooking(bookingId) {
      if (!currentDriver || !currentDriver.phone) {
        alert("Please update your phone number in profile");
        return;
      }

      try {
        await db.collection("bookings").doc(bookingId).update({
          status: "confirmed",
          driverPhone: currentDriver.phone,
          driverName: currentDriver.name || "Driver",
          acceptedAt: new Date().toISOString()
        });
        alert("‚úì Booking accepted!");
        console.log("‚úì Booking accepted:", bookingId);
      } catch (err) {
        console.error("‚úó Error:", err);
        alert("Error: " + err.message);
      }
    }

    async function rejectBooking(bookingId) {
      alert("Reject feature coming soon");
    }

    async function startRide(bookingId) {
      try {
        await db.collection("bookings").doc(bookingId).update({
          status: "in_transit",
          startedAt: new Date().toISOString()
        });
        alert("‚úì Ride started!");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function completeRide(bookingId) {
      try {
        await db.collection("bookings").doc(bookingId).update({
          status: "completed",
          completedAt: new Date().toISOString()
        });
        if (currentDriver) {
          await db.collection("drivers").doc(currentDriver.uid).update({
            totalRides: firebase.firestore.FieldValue.increment(1)
          });
        }
        alert("‚úì Ride completed!");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    function viewDetails(bookingId, type) {
      const list = type === 'available' ? availableBookings : acceptedBookings;
      const booking = list.find(b => b.id === bookingId);
      if (!booking) return;

      const html = `
        <div style="font-size:14px; line-height:1.8;">
          <p><strong>Booking ID:</strong> ${bookingId}</p>
          <p><strong>Customer:</strong> ${booking.name}</p>
          <p><strong>Phone:</strong> <a href="https://wa.me/91${booking.phone}" target="_blank" style="color:#25d366;">üì± ${booking.phone}</a></p>
          <p><strong>Pickup:</strong> ${booking.pickup}</p>
          <p><strong>Drop:</strong> ${booking.drop}</p>
          <p><strong>Distance:</strong> ${(booking.distance || 0).toFixed(2)} km</p>
          <p><strong>Vehicle:</strong> ${booking.vehicle}</p>
          <p><strong>Price:</strong> ‚Çπ${booking.estimatedPrice}</p>
          <p><strong>Loading Help:</strong> ${booking.loadingRequired ? 'Yes' : 'No'}</p>
          ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ''}
          <p><strong>Status:</strong> ${booking.status}</p>
        </div>
      `;

      document.getElementById("detailContent").innerHTML = html;
      document.getElementById("detailModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("detailModal").style.display = "none";
    }

    function closeDirectionsModal() {
      document.getElementById("directionsModal").style.display = "none";
    }

    // Fetch and display turn-by-turn directions
    async function showDirections(lat1, lon1, lat2, lon2) {
      const directionsContent = document.getElementById("directionsContent");
      directionsContent.innerHTML = '<p style="text-align:center;">‚è≥ Loading directions...</p>';
      document.getElementById("directionsModal").style.display = "flex";
      
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&steps=true&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const directions = [];
          
          if (route.legs && route.legs.length > 0) {
            route.legs.forEach(leg => {
              if (leg.steps) {
                leg.steps.forEach((step, idx) => {
                  const bearing = step.maneuver.bearing_after;
                  const directionArrow = getArrow(bearing);
                  directions.push({
                    instruction: step.maneuver.instruction || `Turn ${directionArrow}`,
                    distance: step.distance,
                    duration: Math.round(step.duration),
                    name: step.name || 'Unnamed Road',
                    bearing: bearing,
                    type: step.maneuver.type
                  });
                });
              }
            });
          }
          
          displayDirectionsInModal(directions);
        } else {
          directionsContent.innerHTML = '<p style="color:red;">‚ùå Could not calculate directions. Try again.</p>';
        }
      } catch (err) {
        console.error("Directions error:", err);
        directionsContent.innerHTML = '<p style="color:red;">‚ùå Error loading directions</p>';
      }
    }

    function getArrow(bearing) {
      const arrows = ['‚Üë', '‚Üó', '‚Üí', '‚Üò', '‚Üì', '‚Üô', '‚Üê', '‚Üñ'];
      const index = Math.round(bearing / 45) % 8;
      return arrows[index];
    }

    function displayDirectionsInModal(directions) {
      const directionsContent = document.getElementById("directionsContent");
      
      let html = '<div style="font-size:13px;">';
      html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:15px; border-radius:6px; margin-bottom:15px; text-align:center; font-weight:bold;">
        ‚ñ∂Ô∏è ${directions.length} Turns & Directions
      </div>`;
      
      directions.slice(0, 20).forEach((step, idx) => {
        const nextStep = idx + 1;
        const stepColor = idx === 0 ? '#4CAF50' : '#667eea';
        const stepBg = idx === 0 ? 'rgba(76,175,80,0.15)' : 'rgba(102,126,234,0.1)';
        const timeMin = step.duration < 60 ? step.duration + 's' : Math.ceil(step.duration / 60) + ' min';
        const distKm = (step.distance / 1000).toFixed(2);
        
        html += `
          <div style="background:${stepBg}; padding:12px; margin-bottom:10px; border-radius:6px; border-left:4px solid ${stepColor};">
            <div style="font-weight:bold; color:#333; margin-bottom:5px;">
              ${nextStep}. ${step.instruction}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:12px; color:#666;">
              <div>üõ£Ô∏è <strong>${step.name || 'Road'}</strong></div>
              <div>üìè <strong>${distKm} km</strong></div>
            </div>
            <div style="font-size:11px; color:#999; margin-top:5px;">‚è±Ô∏è ${timeMin}</div>
          </div>
        `;
      });
      
      if (directions.length > 20) {
        html += `<p style="text-align:center; color:#999; font-size:12px; margin-top:10px;">... and ${directions.length - 20} more steps</p>`;
      }
      
      html += '</div>';
      directionsContent.innerHTML = html;
    }

    function updateAllBookings() {
      const statusFilter = document.getElementById("statusFilter").value;
      const searchQuery = document.getElementById("searchBox").value.toLowerCase();
      const container = document.getElementById("allBookingsList");
      
      let filtered = allBookings.filter(b => {
        const matchStatus = !statusFilter || b.status === statusFilter;
        const matchSearch = !searchQuery || 
          b.name.toLowerCase().includes(searchQuery) ||
          b.phone.includes(searchQuery) ||
          b.pickup.toLowerCase().includes(searchQuery) ||
          b.drop.toLowerCase().includes(searchQuery);
        return matchStatus && matchSearch;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No bookings found</div>';
        return;
      }

      container.innerHTML = filtered.map(b => `
        <div class="booking-card">
          <div class="booking-info">
            <div class="booking-info-item">
              <div class="booking-info-label">Customer</div>
              <div class="booking-info-value">${b.name}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Phone</div>
              <div class="booking-info-value"><a href="https://wa.me/91${b.phone}" target="_blank" style="color:#25d366;">üì± ${b.phone}</a></div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">From</div>
              <div class="booking-info-value">${b.pickup}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">To</div>
              <div class="booking-info-value">${b.drop}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Distance</div>
              <div class="booking-info-value">${(b.distance || 0).toFixed(2)} km</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Vehicle</div>
              <div class="booking-info-value">${b.vehicle}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Price</div>
              <div class="booking-info-value">‚Çπ${b.estimatedPrice}</div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Status</div>
              <span class="status-badge status-${b.status}">${b.status}</span>
            </div>
          </div>
          <div class="booking-actions">
            <button class="btn-small btn-accept" onclick="changeStatus('${b.id}', 'confirmed')">‚Üí Confirm</button>
            <button class="btn-small btn-start" onclick="changeStatus('${b.id}', 'in_transit')">‚ñ∂ Transit</button>
            <button class="btn-small btn-complete" onclick="changeStatus('${b.id}', 'completed')">‚úì Complete</button>
            <button class="btn-small" style="background:#6b7280;" onclick="viewAllDetails('${b.id}')">‚ÑπÔ∏è Details</button>
          </div>
        </div>
      `).join("");

      updateMap();
    }

    async function changeStatus(bookingId, newStatus) {
      try {
        await db.collection("bookings").doc(bookingId).update({
          status: newStatus,
          updatedAt: new Date().toISOString()
        });
        alert(`‚úì Status changed to ${newStatus}!`);
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    function viewAllDetails(bookingId) {
      const booking = allBookings.find(b => b.id === bookingId);
      if (!booking) return;

      const vehicleInfo = getVehicleInfo(booking.vehicle);
      const html = `
        <div style="font-size:14px; line-height:1.8;">
          <p><strong>Booking ID:</strong> ${bookingId}</p>
          <p><strong>Customer:</strong> ${booking.name}</p>
          <p><strong>Phone:</strong> <a href="https://wa.me/91${booking.phone}" target="_blank" style="color:#25d366;">üì± ${booking.phone}</a></p>
          <p><strong>Pickup:</strong> ${booking.pickup}</p>
          <p><strong>Drop:</strong> ${booking.drop}</p>
          <p><strong>Distance:</strong> ${(booking.distance || 0).toFixed(2)} km</p>
          <p><strong>Vehicle:</strong> <span style="font-size:24px; margin-right:8px;">${vehicleInfo.emoji}</span><strong>${booking.vehicle}</strong></p>
          <p style="font-size:12px; color:#666; margin-top:-10px;">üì¶ ${vehicleInfo.capacity} | üí∞ Base: ${vehicleInfo.basePrice}</p>
          <p><strong>Price:</strong> ‚Çπ${booking.estimatedPrice}</p>
          <p><strong>Loading Help:</strong> ${booking.loadingRequired ? 'Yes' : 'No'}</p>
          ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ''}
          <p><strong>Status:</strong> <span class="status-badge status-${booking.status}">${booking.status}</span></p>
          ${booking.driverName ? `<p><strong>Driver:</strong> ${booking.driverName}</p>` : ''}
          ${booking.driverPhone ? `<p><strong>Driver Phone:</strong> <a href="https://wa.me/91${booking.driverPhone}" target="_blank" style="color:#25d366;">üì± ${booking.driverPhone}</a></p>` : ''}
          <p><strong>Pickup Coords:</strong> ${booking.pickupLat?.toFixed(4)}, ${booking.pickupLon?.toFixed(4)}</p>
          <p><strong>Drop Coords:</strong> ${booking.dropLat?.toFixed(4)}, ${booking.dropLon?.toFixed(4)}</p>
          <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
          <div style="background: #f0f7ff; padding: 12px; border-radius: 6px; margin-top: 10px;">
            <button onclick="showDirections(${booking.pickupLat}, ${booking.pickupLon}, ${booking.dropLat}, ${booking.dropLon})" style="background: #667eea; color: white; padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;">
              üó∫Ô∏è View Turn-by-Turn Directions
            </button>
          </div>
        </div>
      `;

      document.getElementById("detailContent").innerHTML = html;
      document.getElementById("detailModal").style.display = "flex";
    }

    let map = null;
    let markers = {};

    function initializeMap() {
      if (map) return;
      // Center map on India
      map = L.map('map').setView([20.5937, 78.9629], 5);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19,
        minZoom: 4
      }).addTo(map);
      
      // Restrict map to India bounds only
      const indiaBounds = L.latLngBounds(
        [8.4, 68.7],   // Southwest (Kanyakumari)
        [35.5, 97.4]   // Northeast (Arunachal Pradesh)
      );
      map.setMaxBounds(indiaBounds);
    }

    // Decode polyline from OSRM geometry (simplified version)
    function decodePolyline(encoded) {
      let points = [];
      let index = 0, lat = 0, lng = 0;
      let changes = [];
      
      for (let i = 0; i < encoded.length; i++) {
        let result = 0;
        let shift = 0;
        let b;
        
        do {
          b = encoded.charCodeAt(i) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
          i++;
        } while (b >= 0x20);
        
        let dlat = ~(result >> 1) ? (result >> 1) : (result >> 1);
        changes.push(dlat);
        
        result = 0;
        shift = 0;
        do {
          b = encoded.charCodeAt(i) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
          i++;
        } while (b >= 0x20);
        
        let dlng = ~(result >> 1) ? (result >> 1) : (result >> 1);
        changes.push(dlng);
      }
      
      for (let i = 0; i < changes.length; i += 2) {
        lat += changes[i] / 1e5;
        lng += changes[i + 1] / 1e5;
        points.push([lat, lng]);
      }
      
      return points;
    }

    // Get route from OSRM
    async function getRoutePolyline(lat1, lon1, lat2, lon2) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const coordinates = data.routes[0].geometry.coordinates;
          return coordinates.map(coord => [coord[1], coord[0]]); // Convert [lon,lat] to [lat,lon]
        }
      } catch (err) {
        console.error("Route fetch error:", err);
      }
      return null;
    }

    function updateMap() {
      if (!map) return;

      // Clear existing markers and routes
      Object.values(markers).forEach(marker => {
        if (marker) {
          if (marker.setMap) {
            marker.setMap(null);
          } else {
            map.removeLayer(marker);
          }
        }
      });
      
      // Clear existing polylines
      if (window.routePolylines) {
        window.routePolylines.forEach(poly => map.removeLayer(poly));
      }
      window.routePolylines = [];
      markers = {};

      // Add markers and routes for first 20 bookings
      allBookings.slice(0, 20).forEach(async (booking, idx) => {
        if (booking.pickupLat && booking.pickupLon) {
          // Pickup marker with green color
          const pickupMarker = L.marker([booking.pickupLat, booking.pickupLon], {
            icon: L.icon({
              iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%234CAF50"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
              iconSize: [50, 50],
              iconAnchor: [25, 50],
              popupAnchor: [0, -50]
            })
          }).addTo(map).bindPopup(`<strong>üìç Pickup</strong><br>${booking.name}<br>${booking.pickup}`);
          markers[`pickup_${idx}`] = pickupMarker;
        }

        if (booking.dropLat && booking.dropLon) {
          // Drop marker with red color
          const dropMarker = L.marker([booking.dropLat, booking.dropLon], {
            icon: L.icon({
              iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%23EF4444"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
              iconSize: [50, 50],
              iconAnchor: [25, 50],
              popupAnchor: [0, -50]
            })
          }).addTo(map).bindPopup(`<strong>üéØ Destination</strong><br>${booking.name}<br>${booking.drop}`);
          markers[`drop_${idx}`] = dropMarker;
        }

        // Draw actual route between pickup and drop
        if (booking.pickupLat && booking.pickupLon && booking.dropLat && booking.dropLon) {
          try {
            const routePoints = await getRoutePolyline(
              booking.pickupLat, booking.pickupLon, 
              booking.dropLat, booking.dropLon
            );
            
            if (routePoints && routePoints.length > 0) {
              // Main route line (solid orange)
              const routeLine = L.polyline(routePoints, {
                color: '#ff6b35',
                weight: 5,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
              }).addTo(map);
              
              // Light shadow layer
              const shadowLine = L.polyline(routePoints, {
                color: '#ffffff',
                weight: 7,
                opacity: 0.3,
                lineCap: 'round',
                lineJoin: 'round'
              }).addTo(map);
              
              window.routePolylines.push(shadowLine);
              window.routePolylines.push(routeLine);
              console.log(`‚úì Route drawn for booking ${idx}`);
            } else {
              // Fallback to straight line if route fails
              const fallbackLine = L.polyline([
                [booking.pickupLat, booking.pickupLon],
                [booking.dropLat, booking.dropLon]
              ], {
                color: '#ff6b35',
                weight: 4,
                opacity: 0.6,
                dashArray: '5, 5'
              }).addTo(map);
              
              window.routePolylines.push(fallbackLine);
            }
          } catch (err) {
            console.error(`Error drawing route for booking ${idx}:`, err);
            // Fallback to straight line
            const fallbackLine = L.polyline([
              [booking.pickupLat, booking.pickupLon],
              [booking.dropLat, booking.dropLon]
            ], {
              color: '#ff6b35',
              weight: 4,
              opacity: 0.6,
              dashArray: '5, 5'
            }).addTo(map);
            
            window.routePolylines.push(fallbackLine);
          }
        }
      });
    }
      });
    }

    function exportToCSV() {
      const statusFilter = document.getElementById("statusFilter").value;
      const searchQuery = document.getElementById("searchBox").value.toLowerCase();

      let filtered = allBookings.filter(b => {
        const matchStatus = !statusFilter || b.status === statusFilter;
        const matchSearch = !searchQuery || 
          b.name.toLowerCase().includes(searchQuery) ||
          b.phone.includes(searchQuery) ||
          b.pickup.toLowerCase().includes(searchQuery) ||
          b.drop.toLowerCase().includes(searchQuery);
        return matchStatus && matchSearch;
      });

      if (filtered.length === 0) {
        alert("No bookings to export");
        return;
      }

      const headers = ["Booking ID", "Customer", "Phone", "Pickup", "Drop", "Distance (km)", "Vehicle", "Price", "Status", "Driver", "Driver Phone"];
      const rows = filtered.map(b => [
        b.id || "",
        b.name || "",
        b.phone || "",
        b.pickup || "",
        b.drop || "",
        (b.distance || 0).toFixed(2),
        b.vehicle || "",
        b.estimatedPrice || "",
        b.status || "",
        b.driverName || "",
        b.driverPhone || ""
      ]);

      let csv = headers.join(",") + "\n";
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `bookings-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      console.log("‚úì CSV exported");
    }
  </script>
</body>
</html>
