<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Dashboard - Goods Vehicle Booking</title>
  <meta name="theme-color" content="#000000">
  <meta name="description" content="A comprehensive delivery management platform">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/images/icon-192x192.png">
  <link rel="apple-touch-icon" href="/images/icon-192x192.png">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Hamburger Menu */
    .hamburger {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      margin-right: 15px;
    }

    .nav-menu {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    @media (max-width: 768px) {
      .hamburger {
        display: block;
      }

      .nav-menu {
        position: absolute;
        top: 70px;
        left: 0;
        right: 0;
        flex-direction: column;
        background: #ff6b35;
        gap: 0;
        padding: 20px;
        border-radius: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-height: 300px;
        overflow-y: auto;
        z-index: 999;
      }

      .nav-menu.hidden {
        display: none;
      }

      .nav-menu a,
      .nav-menu button {
        width: 100%;
        text-align: left;
        padding: 12px 0;
        border: none;
        background: none;
      }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-box {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      margin: 10px 0;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }

    #map {
      height: 400px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .booking-list {
      display: grid;
      gap: 15px;
    }

    .booking-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border-left: 5px solid #ff6b35;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .booking-item.completed {
      border-left-color: #10b981;
      opacity: 0.8;
    }

    .booking-header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      align-items: start;
      margin-bottom: 15px;
    }

    .booking-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      font-size: 13px;
    }

    .detail-field {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-weight: 700;
      color: #ff6b35;
      margin-bottom: 3px;
    }

    .detail-value {
      color: #374151;
      word-break: break-word;
    }

    .detail-value a {
      color: #25d366;
      text-decoration: none;
      font-weight: 600;
    }

    .detail-value a:hover {
      text-decoration: underline;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      flex: 1;
      min-width: 80px;
    }

    .btn-confirm {
      background: #10b981;
      color: white;
    }

    .btn-confirm:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .btn-start {
      background: #3b82f6;
      color: white;
    }

    .btn-start:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .btn-complete {
      background: #8b5cf6;
      color: white;
    }

    .btn-complete:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }

    .btn-change {
      background: #6b7280;
      color: white;
    }

    .btn-change:hover {
      background: #4b5563;
      transform: translateY(-2px);
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      color: white;
    }

    .status-new {
      background: #f97316;
    }

    .status-confirmed {
      background: #3b82f6;
    }

    .status-transit {
      background: #a855f7;
    }

    .status-completed {
      background: #10b981;
    }

    .search-filter {
      display: grid;
      grid-template-columns: 1fr 150px 120px;
      gap: 15px;
      margin: 20px 0;
      align-items: end;
    }

    .search-filter input,
    .search-filter select {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .search-filter input:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    }

    .export-button {
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .export-button:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .section h2 {
      color: #ff6b35;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 3px solid #ff6b35;
      padding-bottom: 15px;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .search-filter {
        grid-template-columns: 1fr;
      }

      .booking-details {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-btn {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; flex: 1;">
      <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
      <h1>üöó Driver Dashboard</h1>
    </div>
    <p id="driverInfo" style="margin: 0; opacity: 0.9;">Loading...</p>
  </header>

  <nav class="nav-menu hidden" id="navMenu">
    <a href="index.html" style="color: white; text-decoration: none; font-weight: 600;">üè† Home</a>
    <button onclick="logout()" style="color: white; cursor: pointer; font-weight: 600;">üîì Logout</button>
  </nav>

  <div style="max-width:1400px; margin:0 auto; padding:20px;">
    <!-- Stats Section -->
    <div class="section">
      <h2>üìä Quick Stats</h2>
      <div class="dashboard-grid">
        <div class="stat-box" onclick="filterByStatus('')" style="cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <div class="stat-label">Total Bookings</div>
          <div class="stat-number" id="statTotal">0</div>
        </div>
        <div class="stat-box" onclick="filterByStatus('new')" style="cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <div class="stat-label">New Bookings</div>
          <div class="stat-number" id="statNew">0</div>
        </div>
        <div class="stat-box" onclick="filterByStatus('confirmed')" style="cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <div class="stat-label">Accepted</div>
          <div class="stat-number" id="statConfirmed">0</div>
        </div>
        <div class="stat-box" onclick="filterByStatus('completed')" style="cursor:pointer; transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <div class="stat-label">Completed</div>
          <div class="stat-number" id="statCompleted">0</div>
        </div>
        <div class="stat-box" style="cursor:default; transition:none;">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-number" id="statRevenue">‚Çπ0</div>
        </div>
      </div>
      <button class="logout-btn" id="logoutBtn" style="margin-top:20px; width:100%; max-width:200px;">üîì Logout</button>
    </div>

    <!-- Profile Editor -->
    <div class="section">
      <h2>üë§ My Profile</h2>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:15px;">
        <div>
          <label style="font-weight:700; color:#ff6b35; display:block; margin-bottom:5px;">Name</label>
          <input id="profileName" type="text" placeholder="Your full name" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px;">
        </div>
        <div>
          <label style="font-weight:700; color:#ff6b35; display:block; margin-bottom:5px;">Phone</label>
          <input id="profilePhone" type="text" placeholder="10-digit mobile" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px;">
        </div>
        <div>
          <label style="font-weight:700; color:#ff6b35; display:block; margin-bottom:5px;">Vehicle</label>
          <select id="profileVehicle" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px;">
            <option value="">Select...</option>
            <option value="mini-truck">Mini Truck</option>
            <option value="pickup">Pickup</option>
            <option value="tempo">Tempo</option>
          </select>
        </div>
      </div>
      <button onclick="saveProfile()" style="background:#10b981; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600;">üíæ Save Profile</button>
    </div>

    <!-- YOUR ACCEPTED BOOKINGS (TOP PRIORITY) -->
    <div class="section" style="border-left: 6px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);">
      <h2 style="color: #10b981; display: flex; align-items: center; gap: 10px;">
        ‚úì YOUR ACTIVE BOOKINGS (Priority)
        <span style="font-size: 12px; background: #10b981; color: white; padding: 4px 12px; border-radius: 20px;">Your Tasks</span>
      </h2>
      <div class="booking-list" id="acceptedList">
        <div class="empty">No active bookings. Check "Available Bookings" below!</div>
      </div>
    </div>

    <!-- Map Section - ONLY SHOWN FOR ACCEPTED ORDERS -->
    <div class="section" id="mapSection" style="display: none;">
      <h2>üìç My Current Route</h2>
      <div id="map"></div>
      <p style="font-size:12px; color:#9ca3af; margin:10px 0 0 0;">üü¢ Green = Pickup | üî¥ Red = Drop-off | üü† Route = Actual Path</p>
    </div>

    <!-- Available Bookings -->
    <div class="section" style="border-left: 6px solid #f97316; background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);">
      <h2 style="color: #f97316; display: flex; align-items: center; gap: 10px;">
        üì¶ AVAILABLE BOOKINGS (New Orders)
        <span style="font-size: 12px; background: #f97316; color: white; padding: 4px 12px; border-radius: 20px;">Accept Here</span>
      </h2>
      <div class="booking-list" id="availableList">
        <div class="empty">No available bookings at the moment</div>
      </div>
    </div>

    <!-- All Bookings with Search -->
    <div class="section" style="border-left: 6px solid #6b7280;">
      <h2 style="display: flex; align-items: center; gap: 10px;">
        üìã ALL BOOKINGS (History & Search)
        <span style="font-size: 12px; background: #6b7280; color: white; padding: 4px 12px; border-radius: 20px;">View All</span>
      </h2>
      <div class="search-filter">
        <input id="searchInput" type="text" placeholder="Search by name, phone, pickup, drop...">
        <select id="statusSelect">
          <option value="">All Status</option>
          <option value="new">New</option>
          <option value="confirmed">Confirmed</option>
          <option value="transit">In Transit</option>
          <option value="completed">Completed</option>
        </select>
        <button class="export-button" onclick="exportCSV()">üì• Export</button>
      </div>
      <div class="booking-list" id="allList">
        <div class="empty">No bookings</div>
      </div>
    </div>
  </div>



  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAI4QSMoukoQR8xivZr-0eUUc8kKARkOd4",
      authDomain: "goods-5097f.firebaseapp.com",
      projectId: "goods-5097f",
      storageBucket: "goods-5097f.firebasestorage.app",
      messagingSenderId: "693060796720",
      appId: "1:693060796720:web:091388170ce0c7980348f5",
      measurementId: "G-JT7D3G5TG7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let driver = null;
    let allBookings = [];
    let map = null;
    let markers = [];

    // Toggle Hamburger Menu
    function toggleMenu() {
      const menu = document.getElementById('navMenu');
      if (menu) menu.classList.toggle('hidden');
    }

    // Vehicle icon mapping
    const vehicleIcons = {
      "Mini Truck": { emoji: "üöõ", capacity: "Up to 2 tons", basePrice: "‚Çπ250" },
      "Pickup": { emoji: "üöô", capacity: "Up to 1 ton", basePrice: "‚Çπ200" },
      "Tempo": { emoji: "üöê", capacity: "Up to 3 tons", basePrice: "‚Çπ300" }
    };

    function getVehicleIcon(vehicleName) {
      return vehicleIcons[vehicleName]?.emoji || "üöö";
    }

    function getVehicleInfo(vehicleName) {
      return vehicleIcons[vehicleName] || { emoji: "üöö", capacity: "Standard", basePrice: "‚Çπ200" };
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("üéØ Dashboard DOMContentLoaded starting...");
      
      // Close menu when clicking a link
      const navLinks = document.querySelectorAll('.nav-menu a, .nav-menu button');
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          const menu = document.getElementById('navMenu');
          if (menu) menu.classList.add('hidden');
        });
      });
      
      auth.onAuthStateChanged(user => {
        if (user) {
          console.log("‚úì User logged in:", user.email, user.uid);
          loadDriver(user.uid);
          setTimeout(() => loadAllData(), 500); // Small delay to ensure driver is loaded
          document.getElementById("logoutBtn").style.display = "block";
        } else {
          console.log("‚úó No user logged in");
          document.getElementById("driverInfo").textContent = "Not logged in";
          document.getElementById("logoutBtn").style.display = "none";
          document.getElementById("availableList").innerHTML = '<div class="empty">Please log in first</div>';
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await auth.signOut();
        location.reload();
      });

      document.getElementById("searchInput").addEventListener("keyup", renderAll);
      document.getElementById("statusSelect").addEventListener("change", renderAll);
    });

    async function loadDriver(uid) {
      let doc = await db.collection("drivers").doc(uid).get();
      if (!doc.exists) {
        await db.collection("drivers").doc(uid).set({
          uid, phone: "", name: "", status: "offline", rating: 5, totalRides: 0, createdAt: new Date().toISOString()
        });
        doc = await db.collection("drivers").doc(uid).get();
      }
      driver = { uid, ...doc.data() };
      document.getElementById("driverInfo").textContent = `üë§ ${driver.name || "Driver " + uid.substring(0, 5)} | Phone: ${driver.phone || "Not set"}`;
      console.log("‚úì Driver loaded:", driver.name);
    }

    function loadAllData() {
      console.log("üéØ Setting up real-time listener for bookings...");
      
      // Real-time listener for all bookings
      try {
        const unsubscribe = db.collection("bookings").orderBy("createdAt", "desc").limit(1000).onSnapshot(
          snap => {
            console.log("‚úì Bookings snapshot received, docs:", snap.docs.length);
            allBookings = snap.docs.map(d => {
              const data = d.data();
              console.log(`  - ${data.name} | ${data.status} | ‚Çπ${data.estimatedPrice}`);
              return { id: d.id, ...data };
            });
            console.log("‚úì All bookings loaded:", allBookings.length);
            updateStats();
            renderAvailable();
            renderAccepted();
            renderAll();
            updateMap();
          },
          error => {
            console.error("‚úó Listener error:", error);
            alert("Error loading bookings: " + error.message);
          }
        );
      } catch (error) {
        console.error("‚úó Error setting up listener:", error);
      }
    }

    function updateStats() {
      const total = allBookings.length;
      const newCount = allBookings.filter(b => b.status === "new").length;
      const confirmedCount = allBookings.filter(b => b.status === "confirmed").length;
      const completedCount = allBookings.filter(b => b.status === "completed").length;
      const revenue = allBookings.filter(b => b.status === "completed").reduce((sum, b) => sum + (b.estimatedPrice || 0), 0);

      document.getElementById("statTotal").textContent = total;
      document.getElementById("statNew").textContent = newCount;
      document.getElementById("statConfirmed").textContent = confirmedCount;
      document.getElementById("statCompleted").textContent = completedCount;
      document.getElementById("statRevenue").textContent = "‚Çπ" + revenue.toLocaleString("en-IN");
    }

    function renderAvailable() {
      const available = allBookings.filter(b => b.status === "new");
      const html = available.length === 0 ? '<div class="empty">No available bookings</div>' :
        available.map(b => `
          <div class="booking-item">
            <div class="booking-header">
              <div>
                <strong>${b.name}</strong> ‚Ä¢ <span class="status-badge status-new">New</span>
              </div>
            </div>
            <div class="booking-details">
              <div class="detail-field"><div class="detail-label">Phone</div><div class="detail-value"><a href="https://wa.me/91${b.phone}" target="_blank">üì± ${b.phone}</a></div></div>
              <div class="detail-field"><div class="detail-label">From</div><div class="detail-value">${b.pickup}</div></div>
              <div class="detail-field"><div class="detail-label">To</div><div class="detail-value">${b.drop}</div></div>
              <div class="detail-field"><div class="detail-label">Distance</div><div class="detail-value">${(b.distance || 0).toFixed(2)} km</div></div>
              <div class="detail-field"><div class="detail-label">Vehicle</div><div class="detail-value">${b.vehicle}</div></div>
              <div class="detail-field"><div class="detail-label">Price</div><div class="detail-value">‚Çπ${b.estimatedPrice}</div></div>
            </div>
            <div class="action-buttons" style="margin-top:15px;">
              <button class="action-btn btn-confirm" onclick="acceptBooking('${b.id}')">‚úì Accept</button>
              <button class="action-btn btn-change" onclick="viewBookingMap('${b.id}')">üìç View Route</button>
              <button class="action-btn btn-change" onclick="rejectBooking('${b.id}')">‚úï Reject</button>
            </div>
          </div>
        `).join("");
      document.getElementById("availableList").innerHTML = html;
    }

    function renderAccepted() {
      const accepted = allBookings.filter(b => ["confirmed", "transit"].includes(b.status) && b.driverPhone === driver?.phone);
      const html = accepted.length === 0 ? '<div class="empty">No accepted bookings</div>' :
        accepted.map(b => `
          <div class="booking-item">
            <div class="booking-header">
              <div>
                <strong>${b.name}</strong> ‚Ä¢ <span class="status-badge ${b.status === "confirmed" ? "status-confirmed" : "status-transit"}"> ${b.status === "confirmed" ? "Confirmed" : "In Transit"}</span>
              </div>
            </div>
            <div class="booking-details">
              <div class="detail-field"><div class="detail-label">Phone</div><div class="detail-value"><a href="https://wa.me/91${b.phone}" target="_blank">üì± ${b.phone}</a></div></div>
              <div class="detail-field"><div class="detail-label">From</div><div class="detail-value">${b.pickup}</div></div>
              <div class="detail-field"><div class="detail-label">To</div><div class="detail-value">${b.drop}</div></div>
              <div class="detail-field"><div class="detail-label">Distance</div><div class="detail-value">${(b.distance || 0).toFixed(2)} km</div></div>
            </div>
            <div class="action-buttons" style="margin-top:15px;">
              <button class="action-btn btn-change" onclick="viewBookingMap('${b.id}')">üìç View Route</button>
              ${b.status === "confirmed" ? `<button class="action-btn btn-start" onclick="updateStatus('${b.id}', 'transit')">‚ñ∂ Start Ride</button>` : ""}
              <button class="action-btn btn-complete" onclick="updateStatus('${b.id}', 'completed')">‚úì Complete</button>
            </div>
          </div>
        `).join("");
      document.getElementById("acceptedList").innerHTML = html;
    }

    function renderAll() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusSelect").value;
      let filtered = allBookings.filter(b => {
        const matchStatus = !status || b.status === status;
        const matchSearch = !search || b.name.toLowerCase().includes(search) || b.phone.includes(search) || b.pickup.toLowerCase().includes(search) || b.drop.toLowerCase().includes(search);
        return matchStatus && matchSearch;
      });

      const html = filtered.length === 0 ? '<div class="empty">No bookings found</div>' :
        filtered.map(b => {
          const statusClass = b.status === "transit" ? "status-transit" : `status-${b.status}`;
          return `
            <div class="booking-item ${b.status === "completed" ? "completed" : ""}">
              <div class="booking-header">
                <div><strong>${b.name}</strong> ‚Ä¢ <span class="status-badge ${statusClass}">${b.status === "transit" ? "In Transit" : b.status}</span></div>
              </div>
              <div class="booking-details">
                <div class="detail-field"><div class="detail-label">Phone</div><div class="detail-value"><a href="https://wa.me/91${b.phone}" target="_blank">üì± ${b.phone}</a></div></div>
                <div class="detail-field"><div class="detail-label">From</div><div class="detail-value">${b.pickup}</div></div>
                <div class="detail-field"><div class="detail-label">To</div><div class="detail-value">${b.drop}</div></div>
                <div class="detail-field"><div class="detail-label">Distance</div><div class="detail-value">${(b.distance || 0).toFixed(2)} km</div></div>
                <div class="detail-field"><div class="detail-label">Vehicle</div><div class="detail-value">${b.vehicle}</div></div>
                <div class="detail-field"><div class="detail-label">Price</div><div class="detail-value">‚Çπ${b.estimatedPrice}</div></div>
              </div>
              <div class="action-buttons" style="margin-top:15px;">
                <button class="action-btn btn-confirm" onclick="updateStatus('${b.id}', 'confirmed')">‚Üí Confirm</button>
                <button class="action-btn btn-start" onclick="updateStatus('${b.id}', 'transit')">‚ñ∂ Transit</button>
                <button class="action-btn btn-complete" onclick="updateStatus('${b.id}', 'completed')">‚úì Complete</button>
                <button class="action-btn btn-change" onclick="showDetails('${b.id}')">‚ÑπÔ∏è Info</button>
              </div>
            </div>
          `;
        }).join("");
      document.getElementById("allList").innerHTML = html;
    }

    function filterByStatus(status) {
      console.log("‚Üí Filter by status:", status || "all");
      
      // Clear search and set status filter
      document.getElementById("searchInput").value = "";
      
      if (status === "") {
        document.getElementById("statusSelect").value = "";
      } else {
        document.getElementById("statusSelect").value = status;
      }
      
      // Scroll to all bookings section
      const allBookingsSection = document.getElementById("allList").closest(".section");
      if (allBookingsSection) {
        allBookingsSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      
      // Render filtered results
      renderAll();
    }

    async function acceptBooking(id) {
      if (!driver?.phone) {
        alert("‚ùå Please set your phone number in driver profile first!");
        return;
      }
      try {
        console.log("‚Üí Accepting booking:", id);
        await db.collection("bookings").doc(id).update({
          status: "confirmed",
          driverPhone: driver.phone,
          driverName: driver.name || "Driver " + driver.uid.substring(0, 5),
          driverUid: driver.uid,
          acceptedAt: new Date().toISOString()
        });
        console.log("‚úì Booking accepted successfully");
        alert("‚úÖ Booking accepted! You can now start the ride.");
      } catch (e) {
        console.error("‚úó Error accepting booking:", e);
        alert("‚ùå Error accepting booking: " + e.message);
      }
    }

    async function rejectBooking(id) {
      if (!confirm("Are you sure you want to reject this booking?")) return;
      try {
        console.log("‚Üí Rejecting booking:", id);
        await db.collection("bookings").doc(id).update({
          status: "rejected",
          rejectedBy: driver.phone,
          rejectedAt: new Date().toISOString()
        });
        console.log("‚úì Booking rejected");
        alert("‚úÖ Booking rejected.");
      } catch (e) {
        console.error("‚úó Error rejecting booking:", e);
        alert("‚ùå Error rejecting booking: " + e.message);
      }
    }

    async function updateStatus(id, newStatus) {
      try {
        await db.collection("bookings").doc(id).update({
          status: newStatus,
          updatedAt: new Date().toISOString(),
          ...(newStatus === "transit" && { startedAt: new Date().toISOString() }),
          ...(newStatus === "completed" && { completedAt: new Date().toISOString() })
        });
        if (newStatus === "completed" && driver) {
          await db.collection("drivers").doc(driver.uid).update({
            totalRides: firebase.firestore.FieldValue.increment(1)
          });
        }
        alert("‚úì Status updated!");
      } catch (e) {
        alert("Error: " + e.message);
      }
    }

    function showDetails(id) {
      const booking = allBookings.find(b => b.id === id);
      if (!booking) return;
      const vehicleInfo = getVehicleInfo(booking.vehicle);
      document.getElementById("modalContent").innerHTML = `
        <h3>Booking Details</h3>
        <div style="font-size:14px; line-height:1.8;">
          <p><strong>ID:</strong> ${id}</p>
          <p><strong>Customer:</strong> ${booking.name}</p>
          <p><strong>Phone:</strong> <a href="https://wa.me/91${booking.phone}" target="_blank">üì± ${booking.phone}</a></p>
          <p><strong>Pickup:</strong> ${booking.pickup}</p>
          <p><strong>Drop:</strong> ${booking.drop}</p>
          <p><strong>Distance:</strong> ${(booking.distance || 0).toFixed(2)} km</p>
          <p><strong>Vehicle:</strong> <span style="font-size:24px; margin-right:8px;">${vehicleInfo.emoji}</span><strong>${booking.vehicle}</strong></p>
          <p style="font-size:12px; color:#666; margin-top:-10px;">üì¶ ${vehicleInfo.capacity} | üí∞ Base: ${vehicleInfo.basePrice}</p>
          <p><strong>Price:</strong> ‚Çπ${booking.estimatedPrice}</p>
          <p><strong>Status:</strong> <span class="status-badge status-${booking.status === "transit" ? "transit" : booking.status}">${booking.status === "transit" ? "In Transit" : booking.status}</span></p>
          ${booking.driverName ? `<p><strong>Driver:</strong> ${booking.driverName}</p>` : ""}
          ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ""}
          <hr style="margin:15px 0; border:none; border-top:1px solid #ddd;">
          <button onclick="showDirections(${booking.pickupLat}, ${booking.pickupLon}, ${booking.dropLat}, ${booking.dropLon})" style="background: #667eea; color: white; padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;">
            üó∫Ô∏è View Turn-by-Turn Directions
          </button>
        </div>
      `;
      document.getElementById("modal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    function closeMapModal() {
      document.getElementById("mapModal").style.display = "none";
      if (window.routeMap) {
        window.routeMap.remove();
        window.routeMap = null;
      }
    }

    // View booking on map with full route details
    async function viewBookingMap(bookingId) {
      const booking = allBookings.find(b => b.id === bookingId);
      if (!booking || !booking.pickupLat || !booking.pickupLon || !booking.dropLat || !booking.dropLon) {
        alert("‚ùå Location data not available for this booking");
        return;
      }

      document.getElementById("mapModal").style.display = "flex";
      
      // Small delay to ensure DOM is ready
      setTimeout(() => initRouteMap(booking), 100);
    }

    function initRouteMap(booking) {
      const container = document.getElementById("routeMapContainer");
      if (!container) return;

      // Clear previous map
      if (window.routeMap) {
        window.routeMap.remove();
      }

      // Initialize map
      window.routeMap = L.map(container).setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { 
        maxZoom: 19,
        minZoom: 4
      }).addTo(window.routeMap);

      // Restrict to India bounds
      const indiaBounds = L.latLngBounds(
        [8.4, 68.7],
        [35.5, 97.4]
      );
      window.routeMap.setMaxBounds(indiaBounds);

      // Add markers
      L.marker([booking.pickupLat, booking.pickupLon], {
        icon: L.icon({
          iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%234CAF50"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
          iconSize: [50, 50],
          iconAnchor: [25, 50]
        })
      }).addTo(window.routeMap).bindPopup(`<strong>üü¢ Pickup</strong><br>${booking.pickup}`);

      L.marker([booking.dropLat, booking.dropLon], {
        icon: L.icon({
          iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%23EF4444"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
          iconSize: [50, 50],
          iconAnchor: [25, 50]
        })
      }).addTo(window.routeMap).bindPopup(`<strong>üî¥ Destination</strong><br>${booking.drop}`);

      // Draw route
      drawRouteAndDetails(booking);
    }

    async function drawRouteAndDetails(booking) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${booking.pickupLon},${booking.pickupLat};${booking.dropLon},${booking.dropLat}?overview=full&steps=true&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);

          // Draw route with shadow effect
          L.polyline(coordinates, {
            color: "#ffffff",
            weight: 7,
            opacity: 0.3,
            lineCap: 'round',
            lineJoin: 'round'
          }).addTo(window.routeMap);

          L.polyline(coordinates, {
            color: "#ff6b35",
            weight: 5,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
          }).addTo(window.routeMap);

          // Fit bounds
          const bounds = L.latLngBounds([booking.pickupLat, booking.pickupLon], [booking.dropLat, booking.dropLon]);
          window.routeMap.fitBounds(bounds, { padding: [50, 50] });

          // Display route details
          displayRouteDetails(booking, route);
        } else {
          // Fallback: draw straight line
          L.polyline([[booking.pickupLat, booking.pickupLon], [booking.dropLat, booking.dropLon]], {
            color: "#ff6b35",
            weight: 5,
            opacity: 0.8,
            dashArray: "5, 5"
          }).addTo(window.routeMap);

          const bounds = L.latLngBounds([booking.pickupLat, booking.pickupLon], [booking.dropLat, booking.dropLon]);
          window.routeMap.fitBounds(bounds, { padding: [50, 50] });

          displayBasicRouteDetails(booking);
        }
      } catch (err) {
        console.error("Error loading route:", err);
        // Fallback route
        L.polyline([[booking.pickupLat, booking.pickupLon], [booking.dropLat, booking.dropLon]], {
          color: "#ff6b35",
          weight: 5,
          opacity: 0.8,
          dashArray: "5, 5"
        }).addTo(window.routeMap);

        displayBasicRouteDetails(booking);
      }
    }

    function displayRouteDetails(booking, route) {
      let html = `
        <div style="font-weight:bold; font-size:16px; color:#ff6b35; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #ff6b35;">
          üìç Route Summary
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
          <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #4CAF50;">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üìç PICKUP</div>
            <div style="font-weight:bold; font-size:14px;">${booking.pickup}</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #EF4444;">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üìç DROP-OFF</div>
            <div style="font-weight:bold; font-size:14px;">${booking.drop}</div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:12px; border-radius:8px; text-align:center;">
            <div style="font-size:12px; opacity:0.9;">üìè Distance</div>
            <div style="font-weight:bold; font-size:18px;">${(route.distance / 1000).toFixed(2)} km</div>
          </div>
          <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; padding:12px; border-radius:8px; text-align:center;">
            <div style="font-size:12px; opacity:0.9;">‚è±Ô∏è Duration</div>
            <div style="font-weight:bold; font-size:18px;">${Math.ceil(route.duration / 60)} min</div>
          </div>
          <div style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; padding:12px; border-radius:8px; text-align:center;">
            <div style="font-size:12px; opacity:0.9;">üí∞ Fare</div>
            <div style="font-weight:bold; font-size:18px;">‚Çπ${booking.estimatedPrice}</div>
          </div>
        </div>
      `;

      // Add turn-by-turn directions if available
      if (route.legs && route.legs.length > 0) {
        const directions = [];
        route.legs.forEach(leg => {
          if (leg.steps) {
            leg.steps.forEach((step) => {
              directions.push({
                instruction: step.maneuver.instruction || 'Continue',
                distance: step.distance,
                duration: Math.round(step.duration),
                name: step.name || 'Unnamed Road'
              });
            });
          }
        });

        if (directions.length > 0) {
          html += `
            <div style="font-weight:bold; font-size:14px; color:#ff6b35; margin-bottom:10px;">
              üõ£Ô∏è Turn-by-Turn Directions (${directions.length} steps)
            </div>
          `;

          directions.slice(0, 10).forEach((step, idx) => {
            const distKm = (step.distance / 1000).toFixed(2);
            const timeMin = step.duration < 60 ? step.duration + 's' : Math.ceil(step.duration / 60) + ' min';
            
            html += `
              <div style="background:white; padding:10px; margin-bottom:8px; border-radius:6px; border-left:4px solid #667eea; font-size:13px;">
                <div style="font-weight:bold; color:#333; margin-bottom:3px;">${idx + 1}. ${step.instruction}</div>
                <div style="color:#666; font-size:12px;">üõ£Ô∏è ${step.name} | üìè ${distKm} km | ‚è±Ô∏è ${timeMin}</div>
              </div>
            `;
          });

          if (directions.length > 10) {
            html += `<p style="text-align:center; color:#999; font-size:12px; margin-top:10px;">... and ${directions.length - 10} more steps</p>`;
          }
        }
      }

      document.getElementById("routeDetailsPanel").innerHTML = html;
    }

    function displayBasicRouteDetails(booking) {
      const html = `
        <div style="font-weight:bold; font-size:16px; color:#ff6b35; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #ff6b35;">
          üìç Booking Details
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
          <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #4CAF50;">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üìç PICKUP</div>
            <div style="font-weight:bold; font-size:14px;">${booking.pickup}</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #EF4444;">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üìç DROP-OFF</div>
            <div style="font-weight:bold; font-size:14px;">${booking.drop}</div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:12px; border-radius:8px; text-align:center;">
            <div style="font-size:12px; opacity:0.9;">üìè Distance</div>
            <div style="font-weight:bold; font-size:18px;">${(booking.distance || 0).toFixed(2)} km</div>
          </div>
          <div style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; padding:12px; border-radius:8px; text-align:center;">
            <div style="font-size:12px; opacity:0.9;">üí∞ Fare</div>
            <div style="font-weight:bold; font-size:18px;">‚Çπ${booking.estimatedPrice}</div>
          </div>
        </div>
      `;
      document.getElementById("routeDetailsPanel").innerHTML = html;
    }

    // Show turn-by-turn directions
    async function showDirections(lat1, lon1, lat2, lon2) {
      const modalContent = document.getElementById("modalContent");
      modalContent.innerHTML = '<h3>üó∫Ô∏è Turn-by-Turn Directions</h3><p style="text-align:center;">‚è≥ Loading directions...</p>';
      
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&steps=true&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const directions = [];
          
          if (route.legs && route.legs.length > 0) {
            route.legs.forEach(leg => {
              if (leg.steps) {
                leg.steps.forEach((step) => {
                  directions.push({
                    instruction: step.maneuver.instruction || 'Continue',
                    distance: step.distance,
                    duration: Math.round(step.duration),
                    name: step.name || 'Unnamed Road',
                    bearing: step.maneuver.bearing_after
                  });
                });
              }
            });
          }
          
          displayDirections(directions, modalContent);
        } else {
          modalContent.innerHTML = '<h3>Directions</h3><p style="color:red;">‚ùå Could not load directions</p>';
        }
      } catch (err) {
        console.error("Error:", err);
        modalContent.innerHTML = '<h3>Directions</h3><p style="color:red;">‚ùå Error loading directions</p>';
      }
    }

    function displayDirections(directions, container) {
      let html = '<h3>üó∫Ô∏è Turn-by-Turn Directions</h3><div style="font-size:13px;">';
      html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:15px; border-radius:6px; margin-bottom:15px; text-align:center; font-weight:bold;">
        ‚ñ∂Ô∏è ${directions.length} Turns & Directions
      </div>`;
      
      directions.slice(0, 20).forEach((step, idx) => {
        const nextStep = idx + 1;
        const stepColor = idx === 0 ? '#4CAF50' : '#667eea';
        const stepBg = idx === 0 ? 'rgba(76,175,80,0.15)' : 'rgba(102,126,234,0.1)';
        const timeMin = step.duration < 60 ? step.duration + 's' : Math.ceil(step.duration / 60) + ' min';
        const distKm = (step.distance / 1000).toFixed(2);
        
        html += `
          <div style="background:${stepBg}; padding:12px; margin-bottom:10px; border-radius:6px; border-left:4px solid ${stepColor};">
            <div style="font-weight:bold; color:#333; margin-bottom:5px;">
              ${nextStep}. ${step.instruction}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:12px; color:#666;">
              <div>üõ£Ô∏è <strong>${step.name || 'Road'}</strong></div>
              <div>üìè <strong>${distKm} km</strong></div>
            </div>
            <div style="font-size:11px; color:#999; margin-top:5px;">‚è±Ô∏è ${timeMin}</div>
          </div>
        `;
      });
      
      if (directions.length > 20) {
        html += `<p style="text-align:center; color:#999; font-size:12px; margin-top:10px;">... and ${directions.length - 20} more steps</p>`;
      }
      
      html += '</div>';
      container.innerHTML = html;
    }

    function updateMap() {
      // Only show map section if there are accepted bookings
      const accepted = allBookings.filter(b => ["confirmed", "transit"].includes(b.status) && b.driverPhone === driver?.phone);
      const mapSection = document.getElementById("mapSection");
      if (mapSection) {
        mapSection.style.display = accepted.length > 0 ? "block" : "none";
      }

      if (!map) {
        // Center on India
        map = L.map("map").setView([20.5937, 78.9629], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { 
          maxZoom: 19,
          minZoom: 4
        }).addTo(map);
        
        // Restrict to India bounds
        const indiaBounds = L.latLngBounds(
          [8.4, 68.7],
          [35.5, 97.4]
        );
        map.setMaxBounds(indiaBounds);
      }
      markers.forEach(m => {
        if (m && m.setMap) m.setMap(null);
        else if (m) map.removeLayer(m);
      });
      if (window.routePolylines) window.routePolylines.forEach(p => map.removeLayer(p));
      
      markers = [];
      window.routePolylines = [];

      // Function to fetch route from OSRM
      const getRoutePolyline = async (lat1, lon1, lat2, lon2) => {
        try {
          const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.routes && data.routes.length > 0) {
            const coordinates = data.routes[0].geometry.coordinates;
            return coordinates.map(coord => [coord[1], coord[0]]);
          }
        } catch (err) {
          console.error("Route fetch error:", err);
        }
        return null;
      };

      // Only show accepted bookings on main map
      accepted.slice(0, 20).forEach(async (b, i) => {
        if (b.pickupLat && b.pickupLon) {
          markers.push(L.marker([b.pickupLat, b.pickupLon], {
            icon: L.icon({
              iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%234CAF50"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
              iconSize: [50, 50],
              iconAnchor: [25, 50]
            })
          }).addTo(map).bindPopup(`<strong>üìç Pickup</strong><br>${b.name}<br>${b.pickup}`));
        }
        if (b.dropLat && b.dropLon) {
          markers.push(L.marker([b.dropLat, b.dropLon], {
            icon: L.icon({
              iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="22" fill="%23EF4444"/><circle cx="25" cy="25" r="10" fill="white"/></svg>',
              iconSize: [50, 50],
              iconAnchor: [25, 50]
            })
          }).addTo(map).bindPopup(`<strong>üéØ Destination</strong><br>${b.name}<br>${b.drop}`));
        }
        
        // Draw actual route instead of straight line
        if (b.pickupLat && b.pickupLon && b.dropLat && b.dropLon) {
          try {
            const routePoints = await getRoutePolyline(b.pickupLat, b.pickupLon, b.dropLat, b.dropLon);
            if (routePoints && routePoints.length > 0) {
              // Shadow line
              const shadowLine = L.polyline(routePoints, {
                color: "#ffffff",
                weight: 7,
                opacity: 0.3,
                lineCap: 'round',
                lineJoin: 'round'
              }).addTo(map);
              
              // Main route
              const routeLine = L.polyline(routePoints, { 
                color: "#ff6b35", 
                weight: 5, 
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
              }).addTo(map);

              window.routePolylines.push(shadowLine);
              window.routePolylines.push(routeLine);
            } else {
              // Fallback to straight line
              const fallback = L.polyline([[b.pickupLat, b.pickupLon], [b.dropLat, b.dropLon]], { color: "#ff6b35", weight: 4, opacity: 0.6, dashArray: "5, 5" }).addTo(map);
              window.routePolylines.push(fallback);
            }
          } catch (err) {
            console.error("Error drawing route:", err);
            const fallback = L.polyline([[b.pickupLat, b.pickupLon], [b.dropLat, b.dropLon]], { color: "#ff6b35", weight: 4, opacity: 0.6, dashArray: "5, 5" }).addTo(map);
            window.routePolylines.push(fallback);
          }
        }
      });
    }

    function exportCSV() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusSelect").value;
      let filtered = allBookings.filter(b => {
        const matchStatus = !status || b.status === status;
        const matchSearch = !search || b.name.toLowerCase().includes(search) || b.phone.includes(search);
        return matchStatus && matchSearch;
      });

      if (filtered.length === 0) {
        alert("No bookings to export");
        return;
      }

      const headers = ["ID", "Customer", "Phone", "Pickup", "Drop", "Distance", "Vehicle", "Price", "Status", "Driver", "Created"];
      const rows = filtered.map(b => [b.id || "", b.name || "", b.phone || "", b.pickup || "", b.drop || "", (b.distance || 0).toFixed(2), b.vehicle || "", b.estimatedPrice || "", b.status || "", b.driverName || "", new Date(b.createdAt).toLocaleDateString() || ""]);

      let csv = headers.join(",") + "\n";
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `bookings-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Register Service Worker for offline support and PWA installation
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => {
          console.warn('Service Worker registration failed:', err);
        });
      });
    }
  </script>
</body>
</html>
